# XlatorS 架构设计

## 概述

Xlator这个概念是在GlusterFS架构中得到启发，我加了个S，它可以是Store, 也可以是Service，甚至可以是复数。

人如其名，我是一个翻译员，可以把各种数据翻译成你想要的样子。例如：

你有很多私密的文件，比如照片，它放在本地既占空间，还可能被偷窥，那把它传到云端吧，可是仍然会被人看到，或者被窃取、泄露（服务商会为小客户单独加密数据吗？好像有些历史事件证明并不会...），最后放哪里都不放心。如果你有一个非对称加密翻译，把私钥存放在受信任的客户端，公钥放在任意需要的地方（公司、网吧）。使用翻译器（公钥）对图片加密，上传到云端，需要查看时，把它通过翻译器读到客户端即可（可以阅后即焚），只要私钥不丢，根本不担心泄露、偷窥等问题 ：）

用上面一个简单的使用场景引出XlatorS,

（我觉的这名字真不错，越看越喜欢）

## 架构

XlatorS 系统如图所示，分为以下几个模块：

![design](./images/XlatorS_design.drawio.png "Magic Gardens")

XlatorS 集群:有每个XlatorS组成，前端过来的对象都会经过XlatorS,  数据会由指定的Xlator或Xlator组合来处理（翻译），翻译后的数据就会根据需要存入MetaData Engine 和Data Storage

XlatorS包含多种Xlator，例如：

* Inline Deduplication（在线重删功能），它会在主IO路径中对数据进行：切块 -> 算指纹 -> 查重 -> 引用 -> 数据写盘 -> 提交元数据 等操作最终达到数据重删的目的
  * 详情查看doc/cn/Dedup目录
* Data Protection（数据保护），数据保护是个很大的领域，这里主要针对数据存储安全方向：WORM、FileHash（病毒检测）等
* Data Masking（数据脱敏），在写/读数据时进行数据脱敏，例如对敏感数据做非对称加密...
* 数据分析、用户自定义数据加密/压缩等、集群调度

用户可以根据自己的需求灵活配置，甚至定义自己的数据翻译器。

MetaData Engine: 存放元数据信息，比如：当翻译前后的对象（Object）名或桶（Bucket）名不一一对应时，元数据里会存放对应的映射关系。元数据一般都是热数据，IO操作比较频繁， 所以目前使用Redis/RocketDB等...

## 分布式（need review）

我的初衷是把XlaterS服务都做成无状态的，这样极易做集群的扩展和收缩，也不需要日志拷贝（log replication）等操作，目前还没发现这样有什么问题（need review）

但是集群中的服务一定是有角色的，方便集群的管理与使用（负载、failover等），所以选主是必不可少的

### 选主

考虑使用raft...(TBD)

主节点需要维护集群节点状态表，例如节点健康状态（心跳）、忙碌状态、角色信息等

### 日志复制

目前感觉暂时应该不太需要这个功能

## 部署

因为每个Xlator都是无状态的服务，它可以部署成客户端进行本地翻译，也可以部署成集群中做负载均衡，比如在线重删翻译器，当客户端无法进行CPU密集运算时，就需要其它的节点或集群进行翻译了。
